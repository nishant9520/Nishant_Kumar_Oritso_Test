
@model Models.TaskViewModel

@{
    ViewBag.Title = "Home Page";
}

<main>
    <div class="row">
        <div class="container mt-5">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Create New Task</h4>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("SaveTask", "Task", FormMethod.Post, new { id = "taskForm" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.TaskId)

                        <div class="row g-3">
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                            <div class="col-md-4">
                                @Html.LabelFor(m => m.TaskTitle, new { @class = "form-label fw-bold" })
                                @Html.TextBoxFor(m => m.TaskTitle, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.TaskTitle)
                            </div>

                            <div class="col-md-4">
                                @Html.LabelFor(m => m.TaskDescription, new { @class = "form-label fw-bold" })
                                @Html.TextAreaFor(m => m.TaskDescription, new { @class = "form-control", rows = 3 })
                            </div>

                            <div class="col-md-4">
                                @Html.LabelFor(m => m.TaskDueDate, new { @class = "form-label fw-bold" })
                                @Html.TextBoxFor(m => m.TaskDueDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                            </div>

                            <div class="col-md-4">
                                @Html.LabelFor(m => m.TaskStatus, new { @class = "form-label fw-bold" })
                                @Html.DropDownListFor(m => m.TaskStatus,
                                    new SelectList(new[] { "Pending", "In Progress", "Completed" }),
                                    "-- Select Status --",
                                    new { @class = "form-select" })
                            </div>

                            <div class="col-md-4">
                                @Html.LabelFor(m => m.TaskRemarks, new { @class = "form-label fw-bold" })
                                @Html.TextBoxFor(m => m.TaskRemarks, new { @class = "form-control" })
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-success">
                                    Save Task
                                </button>
                                @Html.ActionLink("Back", "Index", null, new { @class = "btn btn-secondary ms-2" })
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="container mt-5">
            <div class="card-header">
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <input type="text" id="txtSearch" class="form-control" placeholder="Search Title / Description" />
                    </div>
                    <div class="col-md-2">
                        <select id="ddlStatus" class="form-select">
                            <option value="">-- All Status --</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="date" id="fromDate" class="form-control" placeholder="From Date" />
                    </div>
                    <div class="col-md-2">
                        <input type="date" id="toDate" class="form-control" placeholder="To Date" />
                    </div>
                    <div class="col-md-3">
                        <button id="btnFilter" class="btn btn-primary">Filter</button>
                        <button id="btnClear" class="btn btn-secondary ms-1">Clear</button>
                    </div>
                </div>
            </div>
            @*  list *@
            <div id="taskGrid"></div>
        </div>
    </div>
</main>

@section Scripts {
    <script>

function validateDates() {
    let fromDate = $('#fromDate').val();
    let toDate = $('#toDate').val();

    if ((fromDate && !toDate) || (!fromDate && toDate)) {
        alert('Both From Date and To Date must be filled.');
        return false;
    }

    if (fromDate && toDate) {
        if (new Date(toDate) < new Date(fromDate)) {
            alert('To Date cannot be earlier than From Date.');
            return false;
        }
    }

    return true;
}

function loadTasks() {
    if (!validateDates()) {
        return; 
    }

    $.ajax({
        url: '@Url.Action("LoadTaskList", "Home")',
        type: 'GET',
        data: {
            searchText: $('#txtSearch').val(),
            status: $('#ddlStatus').val(),
            fromDate: $('#fromDate').val(),
            toDate: $('#toDate').val()
        },
        success: function (data) {
            $('#taskGrid').html(data);
        },
        error: function () {
            alert('Failed to load tasks.');
        }
    });
}





    $(document).ready(function () {
        loadTasks();

        $('#btnFilter').click(function () {
            loadTasks();
        });


        $('#btnClear').click(function () {
            $('#txtSearch').val('');
            $('#ddlStatus').val('');
            $('#fromDate').val('');
            $('#toDate').val('');
            loadTasks();
        });
    });

        function validateTaskForm() {


            if (!$('#TaskTitle').val().trim()) {
                alert('Task Title is required.');
                return true;

            }

            if (!$('#TaskDescription').val().trim()) {
                alert('Task Description is required.');
               return true;
            }

            if (!$('#TaskDueDate').val().trim()) {
                alert('Task Due Date is required.');
                return true;
            }


            if (!$('#TaskStatus').val() || $('#TaskStatus').val() === "-- Select Status --") {
                alert('Please select a Task Status.');
                return true;
            }



            return false;
        }

    $('#taskForm').submit(function (e) {
        e.preventDefault();
        if (validateTaskForm()) {

            return false;
        }
        $.ajax({
            url: '@Url.Action("SaveTask", "Home")',
            type: 'POST',
            data: $(this).serialize(),
            success: function (res) {
                if (res.success) {
                    alert(res.message);
                    window.location.href = '@Url.Action("Index", "Home")';
                } else {
                    alert(res.message);
                }
            },
            error: function () {
                alert('Error occurred');
            }
        });
    });

   function editTask(task) {

        $('#TaskId').val(task.TaskId);
        $('#TaskTitle').val(task.TaskTitle);
        $('#TaskDescription').val(task.TaskDescription);

       if (task.TaskDueDate) {
           let timestamp = parseInt(task.TaskDueDate.replace(/\/Date\((\d+)\)\//, '$1'), 10);
           let date = new Date(timestamp);
           let dueDate = date.toISOString().split('T')[0];
           $('#TaskDueDate').val(dueDate);
       }


        $('#TaskStatus').val(task.TaskStatus);
        $('#TaskRemarks').val(task.TaskRemarks);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteTask(taskId) {
        if (!confirm("Are you sure you want to delete this task?")) {
            return;
        }

        $.ajax({
            url: '@Url.Action("DeleteTask", "Home")',
            type: 'POST',
            data: { id: taskId },
            success: function (res) {
                if (res.success) {
                    alert(res.message);
                    loadTasks(); // reload grid
                } else {
                    alert(res.message);
                }
            }
        });
    }
    </script>
}